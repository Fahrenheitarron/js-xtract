<html lang="en">
    <head>
        <link rel='stylesheet' type='text/css' href='style.css'>
        <script src="jsXtract.js"></script>
        <script>
            // Build the Web Audio API Context
            var webAudioContext = new (window.AudioContext || window.webkitAudioContext);
            var bufferStore;
            var bufferPlayback;
            var FFT1 = webAudioContext.createAnalyser();
            var FFT2 = webAudioContext.createAnalyser();
            FFT1.smoothingTimeConstant = 0.25;
            FFT2.smoothingTimeConstant = 0.25;
            FFT1.fftSize = 2048;
            FFT2.fftSize = 2048;
            var processIn = webAudioContext.createGain();
            var filter = webAudioContext.createBiquadFilter();
            processIn.connect(filter);
            processIn.connect(FFT1);
            filter.connect(webAudioContext.destination);
            filter.connect(FFT2);
            window.onload = function() {
                // Build the playback nodes
                
                // Build the audio dropper
                var audioDragArea = document.getElementById("audio-drop-point");
                
                window.addEventListener('drop', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                })

                audioDragArea.addEventListener('dragover',function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    e.currentTarget.className = "drop-point drag-over";
                });

                audioDragArea.addEventListener('dragexit',function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    e.currentTarget.className = "drop-point";
                });

                audioDragArea.addEventListener('drop',function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    e.currentTarget.className = "drop-point drag-dropped";
                    var files = e.dataTransfer.files[0];
                    var reader = new FileReader();
                    document.getElementById("audio-drop-point").children[0].textContent = "Decoding";
                    reader.onload = function(decoded) {
                        webAudioContext.decodeAudioData(decoded.target.result, function(decodedData) {
                            bufferStore = decodedData;
                            document.getElementById("play").disabled = false;
                            document.getElementById("audio-drop-point").style.visibility = "hidden";
                        },function(){});
                    }
                    reader.readAsArrayBuffer(files);
                });
                
                window.setInterval(function() {
                    draw();
                },50);
            }
            
            function playClick(event) {
                if(bufferStore != undefined) {
                    if (bufferPlayback == undefined) {
                        bufferPlayback = webAudioContext.createBufferSource();
                        bufferPlayback.buffer = bufferStore;
                        bufferPlayback.connect(processIn);
                        bufferPlayback.start(0);
                        event.currentTarget.textContent = "Stop";
                    } else {
                        bufferPlayback.stop(0);
                        bufferPlayback = undefined;
                        event.currentTarget.textContent = "Play";
                    }
                }
            }
            
            function draw() {
                // Obtain the canvas
                var canvas = document.getElementById("frequency-response");
                // Clear the canvas
                canvContext = canvas.getContext("2d");
                canvContext.clearRect(0,0,canvas.width,canvas.height);
                canvContext.strokeStyle="#808080";
                // Draw the log frequency scale
                major_freqs = [10, 100, 1000, 10000];
                minor_freqs = [20, 30, 40, 50, 60, 70, 80, 90, 200, 300, 400, 500, 600, 700, 800, 900, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 20000];
                // Max is Math.log10(20000) == 4.301029995663981
                // Min is Math.log10(10) == 1
                for (var freq of major_freqs) {
                    // Get the position in normalised range
                    var pos = (Math.log10(freq)-1)/3.301029995663981;
                    var pixel = canvas.width * pos;
                    canvContext.beginPath();
                    canvContext.moveTo(pixel,0);
                    canvContext.lineTo(pixel,canvas.height);
                    canvContext.stroke();
                }
                canvContext.save();
                canvContext.setLineDash([1, 2]);
                for (var freq of minor_freqs) {
                    // Get the position in normalised range
                    var pos = (Math.log10(freq)-1)/3.301029995663981;
                    var pixel = canvas.width * pos;
                    canvContext.beginPath();
                    canvContext.moveTo(pixel,0);
                    canvContext.lineTo(pixel,canvas.height);
                    canvContext.stroke();
                }
                canvContext.restore();
                // Draw the dB scale
                major_dB = [10, 0, -10, -20, -30, -40, -50, -60, -70, -80, -90];
                for (var dB of major_dB) {
                    var pos = 1-(dB+90)/100;
                    var pixel = canvas.height * pos;
                    canvContext.beginPath();
                    canvContext.moveTo(0,pixel);
                    canvContext.lineTo(canvas.width,pixel);
                    canvContext.stroke();
                }
                
                // Draw the Frequency responses
                var Size = FFT1.fftSize/2;
                FrequencyPoints = new Float32Array(Size);
                for (var i=0; i<FrequencyPoints.length; i++)
                {
                    FrequencyPoints[i] = i*((webAudioContext.sampleRate/2)/FrequencyPoints.length);
                }
                FrequencyData = new Float32Array(Size);
                FFT1.getFloatFrequencyData(FrequencyData);
                canvContext.strokeStyle="#FF0000";
                canvContext.beginPath();
                if (FrequencyData[1] > 10) {
                    canvContext.moveTo(0,0);
                }
                else if (FrequencyData[1] < -90) {
                    canvContext.moveTo(0,canvas.height);
                } else {
                    canvContext.moveTo(0,canvas.height * (1-(FrequencyData[1]+90)/100));
                }
                for (var i=0; i<FrequencyData.length; i++) {
                    var x_pos = (Math.log10(FrequencyPoints[i])-1)/3.301029995663981;
                    var x_pixel = canvas.width * x_pos;
                    var y_pos = 0;
                    if (FrequencyData[i] > 10) {
                        y_pos = 0;
                    } else if (FrequencyData[i] < -90) {
                        y_pos = 1;
                    } else {
                        y_pos = 1-(FrequencyData[i]+90)/100;
                    }
                    var y_pixel = canvas.height * y_pos;
                    canvContext.lineTo(x_pixel,y_pixel);
                }
                canvContext.stroke();
                
                FFT2.getFloatFrequencyData(FrequencyData);
                canvContext.strokeStyle="#0000FF";
                canvContext.beginPath();
                if (FrequencyData[1] > 10) {
                    canvContext.moveTo(0,0);
                }
                else if (FrequencyData[1] < -90) {
                    canvContext.moveTo(0,canvas.height);
                } else {
                    canvContext.moveTo(0,canvas.height * (1-(FrequencyData[1]+90)/100));
                }
                for (var i=0; i<FrequencyData.length; i++) {
                    var x_pos = (Math.log10(FrequencyPoints[i])-1)/3.301029995663981;
                    var x_pixel = canvas.width * x_pos;
                    var y_pos = 0;
                    if (FrequencyData[i] > 10) {
                        y_pos = 0;
                    } else if (FrequencyData[i] < -90) {
                        y_pos = 1;
                    } else {
                        y_pos = 1-(FrequencyData[i]+90)/100;
                    }
                    var y_pixel = canvas.height * y_pos;
                    canvContext.lineTo(x_pixel,y_pixel);
                }
                canvContext.stroke();
                
                PhaseData = new Float32Array(Size);
                filter.getFrequencyResponse(FrequencyPoints,FrequencyData,PhaseData);
                canvContext.strokeStyle="#00FFFF";
                canvContext.beginPath();
                for (var i=0; i<FrequencyData.length; i++) {
                    FrequencyData[i] = 20*Math.log10(FrequencyData[i]);
                }
                if (FrequencyData[1] > 10) {
                    canvContext.moveTo(0,0);
                }
                else if (FrequencyData[1] < -90) {
                    canvContext.moveTo(0,canvas.height);
                } else {
                    canvContext.moveTo(0,canvas.height * (1-(FrequencyData[1]+90)/100));
                }
                for (var i=0; i<FrequencyData.length; i++) {
                    var x_pos = (Math.log10(FrequencyPoints[i])-1)/3.301029995663981;
                    var x_pixel = canvas.width * x_pos;
                    var y_pos = 0;
                    if (FrequencyData[i] > 10) {
                        y_pos = 0;
                    } else if (FrequencyData[i] < -90) {
                        y_pos = 1;
                    } else {
                        y_pos = 1-(FrequencyData[i]+90)/100;
                    }
                    var y_pixel = canvas.height * y_pos;
                    canvContext.lineTo(x_pixel,y_pixel);
                }
                canvContext.stroke();
            }
        </script>
    </head>
    <body>
        <h1>Biquad Filter</h1>
        <p>This page shows the biquad filter in action. Drag an audio file into the box above and press play to process your file in real-time. Use the parameters below to control the filter. The spectrogram shows three items: the filter response (cyan), the input FFT (red) and the output FFT (blue).</p>
        <div id="audio-drop-point" class="drop-point">
            <p>Drop an audio file here to play back</p>
        </div>
        <div><button id="play" onclick="playClick(event);">Play</button></div>
        <div class="parameter-controls">
            <p>Parameters</p>
            <table class="parameters" border="0">
                <tr><td>Parameter</td><td>Min</td><td>Range</td><td>Max</td></tr>
                <tr><td>Input Gain</td><td>0dB</td><td><input type="range" min="0" max="24" onmousemove="processIn.gain.value = Math.pow(10,this.value/20);"</td><td>24dB</td></tr>
                <tr><td>Type</td><td/><td><select id="type" onchange ="filter.type=this.value;">
                    <option value="lowpass">Low Pass</option>
                    <option value="highpass">High Pass</option>
                    <option value="bandpass">Band Pass</option>
                    <option value="lowshelf">Low Shelf</option>
                    <option value="highshelf">High Shelf</option>
                    <option value="peaking">Peaking</option>
                    <option value="notch">Notch</option>
                </select></td><td/></tr>
                <tr><td>Frequency</td><td>20Hz</td><td><input id="frequency" type="range" min="1.3" max="4.3" step="0.1" onmousemove="filter.frequency.value = Math.pow(10,this.value)"/></td><td>20kHz</td></tr>
                <tr><td>Q</td><td>0.01</td><td><input id="Q" type="range" min="0.01" max="10" step="0.01" onmousemove="filter.Q.value=this.value;"/></td><td>10</td></tr>
                <tr><td>Gain</td><td>-20dB</td><td><input id="gain" type="range" min="-10" max="10" onmousemove="filter.gain.value=this.value;"/></td><td>+20dB</td></tr>
            </table>
        </div>
        <div id="feedback">
            <canvas id="frequency-response" width="700" height="500"/>
        </div>
    </body>
</html>